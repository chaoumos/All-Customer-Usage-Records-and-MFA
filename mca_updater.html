<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partner Center MCA Manager</title>
    <!-- Bootstrap CSS for styling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; background-color: #f8f9fa; }
        .status-badge { font-size: 0.9em; }
        .error-text { font-size: 0.85em; color: #dc3545; font-family: monospace;}
        #logArea { max-height: 200px; overflow-y: auto; background: #fff; font-family: monospace; font-size: 0.85rem; }
        .table-container { background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

<div class="container-fluid">
    <h2 class="mb-4 text-primary">Microsoft Customer Agreement (MCA) Manager</h2>

    <div class="row">
        <!-- Configuration & Load Section -->
        <div class="col-md-12 mb-3">
            <div class="card">
                <div class="card-header bg-dark text-white">1. Configuration & Loading</div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-5"><label for="accessToken" class="form-label fw-bold">Partner Center Access Token <span class="text-danger">*</span></label><input type="password" class="form-control" id="accessToken" placeholder="Paste your Bearer token here..."></div>
                        <div class="col-md-3"><label for="subscriptionKey" class="form-label fw-bold">API Subscription Key <span class="text-danger">*</span></label><input type="text" class="form-control" id="subscriptionKey" value="000"></div>
                        <div class="col-md-2"><label for="comparisonDate" class="form-label fw-bold">Comparison Date <span class="text-danger">*</span></label><input type="date" class="form-control" id="comparisonDate" value="2023-04-01"></div>
                        <div class="col-md-2"><label for="pageSize" class="form-label fw-bold">Page Size</label><input type="number" class="form-control" id="pageSize" value="1" min="1" max="500"></div>
                    </div>
                    <div class="form-text text-muted my-3">Agreements dated before the 'Comparison Date' or agreements that are 'Not Found' will be flagged for update.</div>
                    <div class="d-grid gap-2 d-md-flex">
                        <button id="btnLoadCustomers" class="btn btn-primary flex-grow-1"><span id="loadSpinner" class="spinner-border spinner-border-sm d-none" role="status"></span> Load First Page & Analyze</button>
                        <button id="btnLoadNext" class="btn btn-secondary flex-grow-1" disabled><span id="loadNextSpinner" class="spinner-border spinner-border-sm d-none" role="status"></span> Load Next Page</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Update Section -->
        <div class="col-md-12 mb-4">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">2. Bulk Update Operations</div>
                <div class="card-body">
                    <p class="card-text small">Enter details of the person attesting to the new agreement, select customers in the table, and click update.</p>
                    <div class="row g-3">
                        <div class="col-md-4"><label for="attestFirstName" class="form-label">Attester First Name <span class="text-danger">*</span></label><input type="text" class="form-control update-input" id="attestFirstName" placeholder="e.g. Jane" disabled></div>
                        <div class="col-md-4"><label for="attestLastName" class="form-label">Attester Last Name <span class="text-danger">*</span></label><input type="text" class="form-control update-input" id="attestLastName" placeholder="e.g. Doe" disabled></div>
                        <div class="col-md-4"><label for="attestEmail" class="form-label">Attester Email <span class="text-danger">*</span></label><input type="email" class="form-control update-input" id="attestEmail" placeholder="e.g. jane.doe@customer.com" disabled></div>
                    </div>
                    <div class="mt-3 d-flex justify-content-between align-items-center">
                        <div><strong>Selected for Update: <span id="selectedCount" class="badge bg-secondary">0</span></strong></div>
                        <div><button id="btnSelectAllNeeded" class="btn btn-outline-secondary btn-sm me-2" disabled>Select All needing update</button><button id="btnUpdateSelected" class="btn btn-danger" disabled><span id="updateSpinner" class="spinner-border spinner-border-sm d-none" role="status"></span> Update Selected Tenants</button></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Log & Results Table -->
    <div class="card mb-3"><div class="card-header py-1">Activity Log & Status</div><div class="card-body p-2"><div id="logArea" class="border rounded p-2 text-secondary">Waiting for action...</div><div class="progress mt-2 d-none" id="progressBarContainer"><div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div></div></div></div>
    <div class="table-container"><h5 class="card-title">Customer MCA Status <small id="tableTitleDate" class="text-muted"></small> <span id="totalLoaded" class="badge bg-info float-end">Total Loaded: 0 / 0</span></h5><div class="table-responsive"><table class="table table-hover align-middle" id="customerTable"><thead class="table-light"><tr><th scope="col" width="50">Select</th><th scope="col">Customer Name</th><th scope="col">Tenant ID</th><th scope="col">Partner MCA Date</th><th scope="col">Partner Attestation Status</th><th scope="col">Self-Signed Status</th></tr></thead><tbody id="tableBody"><tr><td colspan="6" class="text-center text-muted py-4">No data loaded yet.</td></tr></tbody></table></div></div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- MAIN JAVASCRIPT LOGIC -->
<script>
    // --- STATE ---
    let customersNeedingUpdateIds = new Set();
    let globalContinuationToken = null;
    let totalCustomersLoaded = 0;
    let totalCustomersInDirectory = 0;

    // --- DOM ELEMENTS ---
    const ui = { tokenInput: document.getElementById('accessToken'), subscriptionKeyInput: document.getElementById('subscriptionKey'), comparisonDateInput: document.getElementById('comparisonDate'), pageSizeInput: document.getElementById('pageSize'), btnLoad: document.getElementById('btnLoadCustomers'), btnLoadNext: document.getElementById('btnLoadNext'), loadSpinner: document.getElementById('loadSpinner'), loadNextSpinner: document.getElementById('loadNextSpinner'), logArea: document.getElementById('logArea'), tableBody: document.getElementById('tableBody'), tableTitleDate: document.getElementById('tableTitleDate'), totalLoaded: document.getElementById('totalLoaded'), progressBarContainer: document.getElementById('progressBarContainer'), progressBar: document.getElementById('progressBar'), inputFn: document.getElementById('attestFirstName'), inputLn: document.getElementById('attestLastName'), inputEmail: document.getElementById('attestEmail'), btnUpdate: document.getElementById('btnUpdateSelected'), updateSpinner: document.getElementById('updateSpinner'), btnSelectAll: document.getElementById('btnSelectAllNeeded'), selectedCount: document.getElementById('selectedCount'), inputsUpdate: document.querySelectorAll('.update-input') };

    // --- HELPERS ---
    function log(message, type = 'info') { const timestamp = new Date().toLocaleTimeString(); let color = 'text-secondary'; if (type === 'error') color = 'text-danger fw-bold'; if (type === 'success') color = 'text-success'; if (type === 'process') color = 'text-primary'; const entry = document.createElement('div'); entry.className = `${color} border-bottom border-light py-1`; entry.innerHTML = `<small>[${timestamp}]</small> ${message}`; ui.logArea.appendChild(entry); ui.logArea.scrollTop = ui.logArea.scrollHeight; }
    function setProgress(percent, show = true) { ui.progressBarContainer.style.display = show ? 'flex' : 'none'; ui.progressBar.style.width = `${percent}%`; }
    function updateSelectionState() { const checkedBoxes = document.querySelectorAll('.tenant-select:checked'); ui.selectedCount.textContent = checkedBoxes.length; ui.btnUpdate.disabled = checkedBoxes.length === 0; }
    function setConfigControlsDisabled(disabled) { ui.tokenInput.disabled = disabled; ui.subscriptionKeyInput.disabled = disabled; ui.comparisonDateInput.disabled = disabled; ui.pageSizeInput.disabled = disabled; ui.btnLoad.disabled = disabled; }
    function setUpdateControlsDisabled(disabled) { ui.inputsUpdate.forEach(input => input.disabled = disabled); ui.btnUpdate.disabled = disabled; ui.btnSelectAll.disabled = disabled; document.querySelectorAll('.tenant-select').forEach(cb => cb.disabled = disabled); if (disabled) { ui.selectedCount.textContent = '0'; } }
    
    // ==========================================
    // --- API FUNCTIONS ---
    // ==========================================
    async function simpleFetch(url, token, subKey, continuationToken = null, options = {}) {
        const dynamicHeaders = {};
        if (continuationToken) {
            dynamicHeaders['MS-ContinuationToken'] = continuationToken;
        }
        const fetchOptions = { ...options, headers: { 'Authorization': `Bearer ${token}`, 'Accept': 'application/json', 'Ocp-Apim-Subscription-Key': subKey, 'MS-PartnerCenter-Client': 'Partner Center Web', 'MS-CorrelationId': crypto.randomUUID(), 'MS-RequestId': crypto.randomUUID(), 'X-Locale': 'en-US', ...dynamicHeaders, ...options.headers } };
        const response = await fetch(url, fetchOptions);
        if (!response.ok) { let errorDesc = `HTTP ${response.status} - ${response.statusText}`; try { const errJson = await response.json(); errorDesc = `${errJson.code || response.status} - ${errJson.description || response.statusText}`; } catch(e) {} throw new Error(errorDesc); }
        return { data: await response.json(), headers: response.headers };
    }
    
    // *** THIS IS THE FIX (Part 1) ***
    // The continuationToken is now passed correctly to the simpleFetch function.
    async function getCustomersPage(url, token, subKey, continuationToken) {
        log(`Fetching customer page...`, 'process');
        const res = await simpleFetch(url, token, subKey, continuationToken);
        const customers = res.data.items;
        const totalCount = res.data.totalCount;
        const nextContinuationToken = res.data.continuationToken;
        log(`Fetched ${customers.length}. Continuation token ${nextContinuationToken ? 'found' : 'not found'}.`);
        return { customers, totalCount, nextContinuationToken };
    }

    async function getCustomerDetails(customerId, token, subKey) { const [mcaRes, selfSignRes] = await Promise.allSettled([ simpleFetch(`https://api.partnercenter.microsoft.com/v1/customers/${customerId}/agreements`, token, subKey), simpleFetch(`https://api.partnercenter.microsoft.com/v1/customers/${customerId}/directSignedMicrosoftCustomerAgreementStatus`, token, subKey) ]); let partnerMca = null; let partnerMcaError = null; if (mcaRes.status === 'fulfilled') { partnerMca = mcaRes.value.data.items.find(a => a.type === "MicrosoftCustomerAgreement"); } else { partnerMcaError = mcaRes.reason.message; } let selfSignedStatus = "Unknown/Error"; if (selfSignRes.status === 'fulfilled') { selfSignedStatus = selfSignRes.value.data.isSigned === true ? "Signed" : "Not Signed"; } else if (selfSignRes.reason.message.includes('404')) { selfSignedStatus = "N/A"; } else { selfSignedStatus = `Error: ${selfSignRes.reason.message}`; } return { partnerMca, selfSignedStatus, partnerMcaError }; }
    async function performUpdate(customerId, token, subKey, contact) { const url = `https://api.partnercenter.microsoft.com/v1/customers/${customerId}/agreements`; const payload = { primaryContact: { firstName: contact.firstName, lastName: contact.lastName, email: contact.email }, dateAgreed: new Date().toISOString(), templateId: '117a77b0-9360-443b-8795-c6dedc750cf9' }; await simpleFetch(url, token, subKey, null, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); return true; }

    // ==========================================
    // --- UI WORKFLOW FUNCTIONS ---
    // ==========================================
    function createTableRow(customer, details, comparisonDate) { const tr = document.createElement('tr'); tr.setAttribute('data-tenant-id', customer.id); let mcaDateStr = "-"; let partnerStatusHtml = ''; let needsUpdate = false; if (details.partnerMcaError) { partnerStatusHtml = `<div class="error-text">${details.partnerMcaError}</div>`; } else if (details.partnerMca) { const d = new Date(details.partnerMca.dateAgreed); mcaDateStr = d.toISOString().split('T')[0]; if (d < comparisonDate) { partnerStatusHtml = '<span class="badge bg-danger status-badge">Update Required (Old)</span>'; needsUpdate = true; } else { partnerStatusHtml = '<span class="badge bg-success status-badge">Up to date</span>'; } } else { partnerStatusHtml = '<span class="badge bg-warning text-dark status-badge">Update Required (Not Found)</span>'; needsUpdate = true; } if (needsUpdate) { tr.classList.add('table-warning'); customersNeedingUpdateIds.add(customer.id); } let selfSignClass = details.selfSignedStatus === 'Signed' ? 'text-success fw-bold' : 'text-muted'; tr.innerHTML = ` <td class="text-center"> ${needsUpdate ? `<input type="checkbox" class="form-check-input tenant-select" value="${customer.id}">` : ''} </td> <td class="fw-bold">${customer.companyProfile.companyName}</td> <td><small class="text-muted font-monospace">${customer.id}</small></td> <td class="mca-date">${mcaDateStr}</td> <td class="mca-status">${partnerStatusHtml}</td> <td><span class="${selfSignClass}">${details.selfSignedStatus}</span></td> `; return tr; }
    
    ui.btnLoad.addEventListener('click', async () => {
        const token = ui.tokenInput.value.trim();
        const subKey = ui.subscriptionKeyInput.value.trim();
        const comparisonDate = new Date(ui.comparisonDateInput.value);
        const pageSize = ui.pageSizeInput.value;
        if (!token || !subKey || !ui.comparisonDateInput.value) { return alert("Please provide Access Token, Subscription Key, and a valid Comparison Date."); }

        ui.tableTitleDate.textContent = `(Comparison Date: ${ui.comparisonDateInput.value})`;
        ui.logArea.innerHTML = '';
        ui.tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4">...</td></tr>';
        customersNeedingUpdateIds.clear();
        totalCustomersLoaded = 0;
        totalCustomersInDirectory = 0;
        globalContinuationToken = null;
        
        setConfigControlsDisabled(true);
        setUpdateControlsDisabled(true);
        ui.btnLoadNext.disabled = true;
        ui.loadSpinner.classList.remove('d-none');
        setProgress(0);

        try {
            const initialUrl = `https://api.partnercenter.microsoft.com/v1/customers?size=${pageSize}`;
            ui.tableBody.innerHTML = ''; 
            
            const { customers, totalCount, nextContinuationToken } = await getCustomersPage(initialUrl, token, subKey, null);
            globalContinuationToken = nextContinuationToken;
            totalCustomersInDirectory = totalCount;

            for (let i = 0; i < customers.length; i++) {
                const cust = customers[i];
                const details = await getCustomerDetails(cust.id, token, subKey);
                ui.tableBody.appendChild(createTableRow(cust, details, comparisonDate));
                setProgress(((i + 1) / customers.length) * 100);
            }
            
            totalCustomersLoaded += customers.length;
            ui.totalLoaded.textContent = `Total Loaded: ${totalCustomersLoaded} / ${totalCustomersInDirectory}`;
            document.querySelectorAll('.tenant-select').forEach(cb => cb.addEventListener('change', updateSelectionState));
            log('First page analysis complete.', 'success');

        } catch (error) {
            log(`FATAL ERROR: ${error.message}`, 'error');
            ui.tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger py-4">Error. Check credentials and log.</td></tr>`;
            globalContinuationToken = null;
        } finally {
            ui.loadSpinner.classList.add('d-none');
            setConfigControlsDisabled(false);
            setUpdateControlsDisabled(false);
            updateSelectionState();
            ui.btnSelectAll.disabled = customersNeedingUpdateIds.size === 0;
            ui.btnLoadNext.disabled = !globalContinuationToken;
            setProgress(0, false);
        }
    });

    // *** THIS IS THE FIX (Part 2) ***
    // This function now correctly uses the seekOperation and passes the token in the header.
    ui.btnLoadNext.addEventListener('click', async () => {
        if (!globalContinuationToken) { return; }
        
        const token = ui.tokenInput.value.trim();
        const subKey = ui.subscriptionKeyInput.value.trim();
        const comparisonDate = new Date(ui.comparisonDateInput.value);
        const pageSize = ui.pageSizeInput.value;
        
        setConfigControlsDisabled(true);
        setUpdateControlsDisabled(true);
        ui.btnLoadNext.disabled = true;
        ui.loadNextSpinner.classList.remove('d-none');
        setProgress(0);

        try {
            const nextUrl = `https://api.partnercenter.microsoft.com/v1/customers?size=${pageSize}&seekOperation=Next`;
            log(`Calling next page URL: ${nextUrl}`);
            
            const { customers, totalCount, nextContinuationToken } = await getCustomersPage(nextUrl, token, subKey, globalContinuationToken);
            globalContinuationToken = nextContinuationToken;
            totalCustomersInDirectory = totalCount;

            for (let i = 0; i < customers.length; i++) {
                const cust = customers[i];
                const details = await getCustomerDetails(cust.id, token, subKey);
                ui.tableBody.appendChild(createTableRow(cust, details, comparisonDate));
                setProgress(((i + 1) / customers.length) * 100);
            }

            totalCustomersLoaded += customers.length;
            ui.totalLoaded.textContent = `Total Loaded: ${totalCustomersLoaded} / ${totalCustomersInDirectory}`;
            document.querySelectorAll('.tenant-select').forEach(cb => cb.addEventListener('change', updateSelectionState));
            log('Next page analysis complete.', 'success');

        } catch (error) {
            log(`FATAL ERROR: ${error.message}`, 'error');
            globalContinuationToken = null;
        } finally {
            ui.loadNextSpinner.classList.add('d-none');
            setConfigControlsDisabled(false);
            setUpdateControlsDisabled(false);
            updateSelectionState();
            ui.btnSelectAll.disabled = customersNeedingUpdateIds.size === 0;
            ui.btnLoadNext.disabled = !globalContinuationToken;
            setProgress(0, false);
        }
    });

    ui.btnSelectAll.addEventListener('click', () => { document.querySelectorAll('tr.table-warning .tenant-select').forEach(cb => { cb.checked = true; }); updateSelectionState(); });

    ui.btnUpdate.addEventListener('click', async () => {
        const token = ui.tokenInput.value.trim();
        const subKey = ui.subscriptionKeyInput.value.trim();
        const contact = { firstName: ui.inputFn.value.trim(), lastName: ui.inputLn.value.trim(), email: ui.inputEmail.value.trim() };
        if (!contact.firstName || !contact.lastName || !contact.email.includes('@')) { return alert("Please provide valid First Name, Last Name, and Email."); }
        const tenantsToUpdate = Array.from(document.querySelectorAll('.tenant-select:checked')).map(cb => cb.value);
        if (tenantsToUpdate.length === 0) return;
        if (!confirm(`Update MCA for ${tenantsToUpdate.length} customers with attester: ${contact.email}?`)) return;

        log(`Starting bulk update...`, 'process');
        setConfigControlsDisabled(true);
        setUpdateControlsDisabled(true);
        ui.btnLoadNext.disabled = true;
        ui.updateSpinner.classList.remove('d-none');
        setProgress(0);
        let successCount = 0, failCount = 0;
        const todayStr = new Date().toISOString().split('T')[0];
        for (let i = 0; i < tenantsToUpdate.length; i++) {
            const tenantId = tenantsToUpdate[i];
            const row = document.querySelector(`tr[data-tenant-id="${tenantId}"]`);
            const customerName = row.children[1].textContent;
            log(`[${i+1}/${tenantsToUpdate.length}] Updating ${customerName}...`);
            try {
                await performUpdate(tenantId, token, subKey, contact);
                log(`  -> Success.`, 'success'); successCount++; row.classList.remove('table-warning'); row.classList.add('table-success'); row.querySelector('.mca-status').innerHTML = '<span class="badge bg-success status-badge">Updated</span>'; row.querySelector('.mca-date').textContent = todayStr; const cb = row.querySelector('.tenant-select'); if (cb) { cb.checked = false; cb.remove(); } setTimeout(() => row.classList.remove('table-success'), 2000);
            } catch (error) {
                log(`  -> Failed: ${error.message}`, 'error'); failCount++; row.classList.add('table-danger');
            }
            setProgress(((i + 1) / tenantsToUpdate.length) * 100);
        }
        log(`Bulk update finished. Success: ${successCount}, Failed: ${failCount}.`, 'process');
        ui.updateSpinner.classList.add('d-none');
        setConfigControlsDisabled(false);
        setUpdateControlsDisabled(false);
        setProgress(0, false);
        updateSelectionState();
        ui.btnSelectAll.disabled = document.querySelectorAll('tr.table-warning .tenant-select').length === 0;
        ui.btnLoadNext.disabled = !globalContinuationToken;
    });
</script>
</body>
</html>
